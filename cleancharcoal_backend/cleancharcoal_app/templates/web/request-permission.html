<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Burning Permission - Clean Charcoal Rwanda</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #2E7D32;
            --primary-orange: #F57C00;
            --primary-dark: #1B5E20;
            --primary-light: #A5D6A7;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            text-decoration: none;
        }
        
        .logo-rwanda {
            color: var(--primary-orange);
        }
        
        .permission-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 15px;
        }
        
        .permission-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .page-title {
            color: var(--primary-dark);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--primary-orange);
            padding-bottom: 10px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }
        
        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
        }
        
        .step.active .step-circle {
            background: var(--primary-green);
            color: white;
        }
        
        .step-text {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .step.active .step-text {
            color: var(--primary-green);
            font-weight: 600;
        }
        
        .form-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .form-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-label {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.25rem rgba(46, 125, 50, 0.25);
        }
        
        .btn-primary {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .btn-outline-primary {
            color: var(--primary-green);
            border-color: var(--primary-green);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }
        
        .required-field::after {
            content: ' *';
            color: #dc3545;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .permission-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .summary-label {
            color: #6c757d;
        }
        
        .summary-value {
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .success-screen {
            text-align: center;
            padding: 40px 20px;
        }
        
        .success-icon {
            font-size: 4rem;
            color: var(--primary-green);
            margin-bottom: 20px;
        }
        
        .permission-id {
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            margin: 20px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .permission-card {
                padding: 20px;
            }
            
            .step-indicator {
                flex-wrap: wrap;
            }
            
            .step {
                flex: 0 0 33.333%;
                margin-bottom: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="logo" href="{% url 'web_home' %}">
                <span>ðŸŒ±</span>
                <span>CleanCharcoal<span class="logo-rwanda">Rwanda</span></span>
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'web_burner_dashboard' %}">
                    <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                </a>
                <a class="nav-link" href="{% url 'web_home' %}">
                    <i class="fas fa-home me-1"></i> Home
                </a>
                <a class="nav-link" href="#" onclick="handleLogout(event); return false;">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="permission-container">
        <div class="permission-card">
            <h2 class="page-title">Request Burning Permission</h2>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-text">Application Details</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-text">Review & Submit</div>
                </div>
            </div>

            <!-- Step 1: Application Details -->
            <div class="form-section active" id="section1">
                <h5 class="mb-4">Application Details</h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="kilnDistrict" class="form-label required-field">District</label>
                        <input type="text" class="form-control" id="kilnDistrict" 
                               placeholder="Enter district" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="kilnSector" class="form-label required-field">Sector</label>
                        <input type="text" class="form-control" id="kilnSector" 
                               placeholder="Enter sector" required>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="kilnCell" class="form-label required-field">Cell</label>
                        <input type="text" class="form-control" id="kilnCell" 
                               placeholder="Enter cell" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="kilnVillage" class="form-label required-field">Village</label>
                        <input type="text" class="form-control" id="kilnVillage" 
                               placeholder="Enter village" required>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="startDate" class="form-label required-field">Start Date</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="endDate" class="form-label required-field">End Date</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                </div>
               
                
                <div class="action-buttons">
                    <button type="button" class="btn btn-outline-primary" onclick="goToSection(2)">
                        Next <i class="fas fa-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Review & Submit -->
            <div class="form-section" id="section2">
                <h5 class="mb-4">Review & Submit</h5>
                
                <div class="permission-summary">
                    <h6 class="mb-3">Application Summary</h6>
                    
                    <div class="summary-item">
                        <span class="summary-label">District:</span>
                        <span class="summary-value" id="summaryDistrict">-</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Sector:</span>
                        <span class="summary-value" id="summarySector">-</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Cell:</span>
                        <span class="summary-value" id="summaryCell">-</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Village:</span>
                        <span class="summary-value" id="summaryVillage">-</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Duration:</span>
                        <span class="summary-value" id="summaryDuration">-</span>
                    </div>
                    
                    
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    By submitting this application, you agree to abide by all environmental regulations and safety guidelines.
                </div>
                
                <div class="action-buttons">
                    <button type="button" class="btn btn-outline-primary" onclick="goToSection(1)">
                        <i class="fas fa-arrow-left me-1"></i> Back
                    </button>
                    <button type="button" class="btn btn-success" onclick="submitPermission()">
                        <i class="fas fa-paper-plane me-1"></i> Submit Application
                    </button>
                </div>
            </div>

            <!-- Success Screen -->
            <div class="form-section" id="successSection">
                <div class="success-screen">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    
                    <h4 class="text-success mb-3">Application Submitted Successfully!</h4>
                    
                    <p>Your burning permission request has been received and is under review.</p>
                    
                    <div class="permission-id" id="permissionId">
                        PER-2024-0000
                    </div>
                    
                    <p class="text-muted">
                        You will receive a notification once your application is reviewed by community leaders.
                        Estimated review time: 24-48 hours.
                    </p>
                    
                    <div class="action-buttons">
                        <a href="{% url 'web_burner_dashboard' %}" class="btn btn-primary">
                            <i class="fas fa-tachometer-alt me-1"></i> Go to Dashboard
                        </a>
                        <a href="{% url 'web_home' %}" class="btn btn-outline-primary">
                            <i class="fas fa-home me-1"></i> Back to Home
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Modal -->
        <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="errorModalLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>Submission Failed
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
                        </div>
                        <h5 class="text-center mb-3">Permission Request Failed</h5>
                        <div class="alert alert-danger">
                            <p class="mb-0" id="errorMessage">An error occurred while submitting your permission request.</p>
                        </div>
                        <div id="errorDetails" class="mt-3" style="display: none;">
                            <strong>Details:</strong>
                            <ul id="errorDetailsList" class="mt-2"></ul>
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help Section -->
        <div class="permission-card">
            <h5 class="mb-3"><i class="fas fa-question-circle me-2"></i> Need Help?</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-phone me-2"></i> Contact Support</h6>
                    <p class="mb-2">Phone: +250 788 123 456</p>
                    <p>Email: support@cleancharcoal.rw</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-clock me-2"></i> Processing Time</h6>
                    <p>Applications are typically reviewed within 24-48 hours during business days.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Permission Request JavaScript -->
    <script>
        let currentSection = 1;
        let permissionData = {};

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“‹ Permission Request Page Loaded');
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').min = today;
            document.getElementById('endDate').min = today;
            
            // Start date change updates end date min
            document.getElementById('startDate').addEventListener('change', function() {
                document.getElementById('endDate').min = this.value;
            });
        });

        // Navigation between sections
        function goToSection(sectionNumber) {
            // Validate current section before moving
            if (!validateCurrentSection()) {
                return;
            }
            
            // Update step indicators
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(`step${sectionNumber}`).classList.add('active');
            
            // Hide all sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show target section
            document.getElementById(`section${sectionNumber}`).classList.add('active');
            
            // Update current section
            currentSection = sectionNumber;
            
            // If going to review section, update summary
            if (sectionNumber === 2) {
                updateSummary();
            }
        }

        function validateCurrentSection() {
            if (currentSection === 1) {
                return validateSection1();
            }
            return true;
        }

        function validateSection1() {
            const requiredFields = [
                'kilnDistrict',
                'kilnSector',
                'kilnCell',
                'kilnVillage',
                'startDate',
                'endDate'
            ];
            
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            // Validate date range
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate && startDate > endDate) {
                document.getElementById('endDate').classList.add('is-invalid');
                alert('End date must be after start date');
                isValid = false;
            }
            
            if (!isValid) {
                alert('Please fill in all required fields correctly');
            }
            
            return isValid;
        }


        function updateSummary() {
            // Collect data from form
            permissionData = {
                district: document.getElementById('kilnDistrict').value,
                sector: document.getElementById('kilnSector').value,
                cell: document.getElementById('kilnCell').value,
                village: document.getElementById('kilnVillage').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value
            };
            
            // Update summary display
            document.getElementById('summaryDistrict').textContent = permissionData.district || '-';
            document.getElementById('summarySector').textContent = permissionData.sector || '-';
            document.getElementById('summaryCell').textContent = permissionData.cell || '-';
            document.getElementById('summaryVillage').textContent = permissionData.village || '-';
            document.getElementById('summaryDuration').textContent = 
                `${permissionData.startDate} to ${permissionData.endDate}`;
        }

        function getDisplayValue(value, type) {
            return value || '-';
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function submitPermission() {
            // Show loading
            const submitBtn = document.querySelector('#section2 .btn-success');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Submitting...';
            submitBtn.disabled = true;
            
            try {
                // Get form data
                const district = document.getElementById('kilnDistrict').value.trim();
                const sector = document.getElementById('kilnSector').value.trim();
                const cell = document.getElementById('kilnCell').value.trim();
                const village = document.getElementById('kilnVillage').value.trim();
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                // Combine cell and village for activity_location
                const activityLocation = [cell, village].filter(Boolean).join(', ') || 'Not specified';
                
                // Prepare form data
                const formData = new FormData();
                formData.append('kiln_district', district);
                formData.append('kiln_sector', sector);
                formData.append('kiln_cell', cell);
                formData.append('kiln_village', village);
                formData.append('activity_location', activityLocation);
                formData.append('kiln_site_name', `${district} - ${sector} Site`);
                formData.append('start_date', startDate);
                formData.append('end_date', endDate);
                formData.append('purpose', 'Burning permission request');
                
                // Get CSRF token
                const csrftoken = getCookie('csrftoken');
                const token = localStorage.getItem('token');
                
                // Call API
                const headers = {};
                if (csrftoken) {
                    headers['X-CSRFToken'] = csrftoken;
                }
                if (token) {
                    headers['Authorization'] = `Token ${token}`;
                }
                
                const response = await fetch('/api/burner/permissions/create/', {
                    method: 'POST',
                    headers: headers,
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // Extract error message and details
                    let errorMessage = data.error || data.detail || 'Failed to submit permission request';
                    let errorDetails = null;
                    
                    // Check if there are detailed error messages
                    if (data.details) {
                        if (typeof data.details === 'object') {
                            errorDetails = data.details;
                            // If details has a hint, include it in the main message
                            if (data.details.hint) {
                                errorMessage += '. ' + data.details.hint;
                            }
                        } else {
                            errorMessage += ': ' + data.details;
                        }
                    }
                    
                    // Check for specific error messages (like "No leader found")
                    if (data.error && typeof data.error === 'string') {
                        errorMessage = data.error;
                        // If there's a details object with hint, append it
                        if (data.details && data.details.hint) {
                            errorMessage += '. ' + data.details.hint;
                        }
                    }
                    
                    // Show error modal
                    showErrorModal(errorMessage, errorDetails);
                    
                    // Reset button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                // Show success screen
                const permissionId = `PER-${data.id}`;
                document.getElementById('permissionId').textContent = permissionId;
                goToSuccessScreen();
                
            } catch (error) {
                console.error('Error submitting permission:', error);
                
                // Show error modal
                let errorMessage = error.message || 'Failed to submit permission request. Please try again.';
                
                // If it's a network error or other issue, show a user-friendly message
                if (error.message && error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                }
                
                showErrorModal(errorMessage);
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        function showErrorModal(errorMessage, errorDetails = null) {
            // Set error message
            document.getElementById('errorMessage').textContent = errorMessage;
            
            // Show error details if available
            const errorDetailsDiv = document.getElementById('errorDetails');
            const errorDetailsList = document.getElementById('errorDetailsList');
            
            if (errorDetails && typeof errorDetails === 'object') {
                errorDetailsList.innerHTML = '';
                Object.keys(errorDetails).forEach(key => {
                    const li = document.createElement('li');
                    li.textContent = `${key}: ${errorDetails[key]}`;
                    errorDetailsList.appendChild(li);
                });
                errorDetailsDiv.style.display = 'block';
            } else {
                errorDetailsDiv.style.display = 'none';
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }

        function goToSuccessScreen() {
            // Hide all sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show success section
            document.getElementById('successSection').classList.add('active');
            
            // Mark all steps as completed
            document.querySelectorAll('.step').forEach(step => {
                step.classList.add('completed');
            });
        }

        // Handle logout
        async function handleLogout(event) {
            event.preventDefault();
            try {
                const csrftoken = getCookie('csrftoken');
                await fetch('/api/auth/logout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    credentials: 'include'
                });
                window.location.href = '/login/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login/';
            }
        }
    </script>
</body>
</html>