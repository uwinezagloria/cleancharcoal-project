<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Permits - Clean Charcoal Rwanda</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Shared Styles based on leader-dashboard.html */
        body { font-family: 'Roboto', sans-serif; background: #f8f9fa; }
        .dashboard-container { min-height: 100vh; }
        .sidebar { background: linear-gradient(135deg, #1F2A38, #1F2A38); color: white; min-height: 100vh; padding: 20px; }
        .main-content { padding: 30px; }
        .review-table-card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            overflow: hidden; /* Ensures table corners match card */
        }
        
        /* Active link highlight color matches sidebar gradient */
        .list-group-item.active {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-left: 5px solid #F57C00 !important;
            color: white !important;
            font-weight: 600;
        }

        /* Leader-specific colors */
        .text-pending { color: #ffc107 !important; }
        .text-approved-kilns { color: #198754 !important; }
        .text-active-emissions { color: #dc3545 !important; }

        .status-pending { background-color: #ffc107; color: #343a40; font-weight: 600; }
        .status-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="row g-0">
            <div class="col-md-3 sidebar">
                <div class="text-center mb-4">
                    <h3>ðŸŒ± CleanCharcoal</h3>
                    <p class="mb-0">Leader Dashboard</p>
                </div>
                <div class="list-group">
                    <a href="{% url 'web_leader_dashboard' %}" class="list-group-item list-group-item-action bg-transparent text-white border-0">
                        <i class="fas fa-home me-2"></i> Overview
                    </a>
                    <a href="{% url 'web_leader_review' %}" class="list-group-item list-group-item-action bg-transparent text-white border-0 active">
                        <i class="fas fa-list-check me-2"></i> Review Permits 
                        <span class="badge bg-warning text-dark float-end" id="pendingCount">-</span>
                    </a>
                    <a href="#" onclick="handleLogout(event); return false;" class="list-group-item list-group-item-action bg-transparent text-white border-0 mt-4">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </a>
                </div>
            </div>
            
            <div class="col-md-9 main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-dark"><i class="fas fa-list-check me-2"></i> Pending Permit Review</h2>
                    <span class="text-pending fw-bold h4" id="pendingApplicationsCount">Loading...</span>
                </div>
                
                <div id="permissions-container">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading permissions...</p>
                    </div>
                </div>

                <div class="text-center mt-5">
                    <a href="{% url 'web_leader_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Back to Overview
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Permission Modal -->
    <div class="modal fade" id="reviewPermissionModal" tabindex="-1" aria-labelledby="reviewPermissionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="reviewPermissionModalLabel">
                        <i class="fas fa-file-alt me-2"></i>Review Permission Request
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reviewPermissionModalBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="approveBtn" onclick="makeDecision('approved')">
                        <i class="fas fa-check me-2"></i>Approve
                    </button>
                    <button type="button" class="btn btn-warning" id="appointmentBtn" onclick="makeDecision('appointment_required')">
                        <i class="fas fa-calendar me-2"></i>Request Appointment
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectBtn" onclick="makeDecision('rejected')">
                        <i class="fas fa-times me-2"></i>Reject
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Handle logout
        async function handleLogout(event) {
            event.preventDefault();
            try {
                const csrftoken = getCookie('csrftoken');
                await fetch('/api/auth/logout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    credentials: 'include'
                });
                window.location.href = '/login/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login/';
            }
        }

        // Load permissions data
        async function loadPermissions() {
            try {
                const token = localStorage.getItem('token');
                const csrftoken = getCookie('csrftoken');
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (csrftoken) {
                    headers['X-CSRFToken'] = csrftoken;
                }
                if (token) {
                    headers['Authorization'] = `Token ${token}`;
                }
                
                const response = await fetch('/api/leader/permissions/', {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login/';
                        return;
                    }
                    throw new Error('Failed to load permissions');
                }

                const permissions = await response.json();
                console.log('Permissions data received:', permissions);
                
                const container = document.getElementById('permissions-container');
                const pendingCount = permissions.filter(p => p.status === 'submitted' || p.status === 'appointment_required').length;
                
                document.getElementById('pendingApplicationsCount').textContent = `${pendingCount} Applications Pending`;
                document.getElementById('pendingCount').textContent = pendingCount;

                if (permissions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No permission requests to review</p>
                        </div>
                    `;
                    return;
                }

                // Filter to show only pending/submitted/appointment_required
                const pendingPermissions = permissions.filter(p => 
                    p.status === 'submitted' || p.status === 'appointment_required'
                );

                if (pendingPermissions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <p class="text-muted">All permissions have been reviewed</p>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="review-table-card table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Applicant</th>
                                    <th>Location</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                pendingPermissions.forEach(perm => {
                    const location = [
                        perm.kiln_district,
                        perm.kiln_sector
                    ].filter(Boolean).join(', ') || 'Not specified';
                    
                    const startDate = perm.start_date ? new Date(perm.start_date).toLocaleDateString() : 'N/A';
                    const endDate = perm.end_date ? new Date(perm.end_date).toLocaleDateString() : 'N/A';
                    const duration = `${startDate} to ${endDate}`;
                    
                    const burnerName = `${perm.burner_first_name || ''} ${perm.burner_last_name || ''}`.trim() || perm.burner_email || 'Unknown';
                    const statusClass = perm.status === 'submitted' ? 'status-pending' : 'bg-info';
                    const statusText = perm.status === 'submitted' ? 'PENDING' : 'APPOINTMENT REQUIRED';
                    
                    html += `
                        <tr>
                            <td>PER-${perm.id}</td>
                            <td>${escapeHtml(burnerName)}</td>
                            <td>${escapeHtml(location)}</td>
                            <td>${duration}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning" onclick="reviewPermission(${perm.id})">
                                    Review
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading permissions:', error);
                document.getElementById('permissions-container').innerHTML = 
                    '<div class="alert alert-danger">Failed to load permissions. Please try again later.</div>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let currentPermissionId = null;
        let currentPermissionData = null;

        async function reviewPermission(permissionId) {
            currentPermissionId = permissionId;
            
            try {
                const token = localStorage.getItem('token');
                const csrftoken = getCookie('csrftoken');
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (csrftoken) {
                    headers['X-CSRFToken'] = csrftoken;
                }
                if (token) {
                    headers['Authorization'] = `Token ${token}`;
                }
                
                const response = await fetch(`/api/leader/permissions/${permissionId}/`, {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load permission details');
                }

                const permission = await response.json();
                currentPermissionData = permission;
                
                // Populate modal with permission details
                const modalBody = document.getElementById('reviewPermissionModalBody');
                const location = [
                    permission.kiln_district,
                    permission.kiln_sector
                ].filter(Boolean).join(', ') || 'Not specified';
                
                const burnerName = `${permission.burner_first_name || ''} ${permission.burner_last_name || ''}`.trim() || permission.burner_email || 'Unknown';
                const startDate = permission.start_date ? new Date(permission.start_date).toLocaleDateString() : 'N/A';
                const endDate = permission.end_date ? new Date(permission.end_date).toLocaleDateString() : 'N/A';
                
                modalBody.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Request ID:</strong> PER-${permission.id}
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong> 
                            <span class="badge ${permission.status === 'submitted' ? 'bg-warning' : 'bg-info'}">${permission.status.toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Applicant:</strong> ${escapeHtml(burnerName)}
                        </div>
                        <div class="col-md-6">
                            <strong>Email:</strong> ${escapeHtml(permission.burner_email || 'N/A')}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Location:</strong> ${escapeHtml(location)}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Start Date:</strong> ${startDate}
                        </div>
                        <div class="col-md-6">
                            <strong>End Date:</strong> ${endDate}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Purpose:</strong> ${escapeHtml(permission.purpose || 'Not specified')}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Estimated Quantity:</strong> ${permission.estimated_quantity_kg || 0} kg
                        </div>
                    </div>
                    ${permission.leader_note ? `
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Previous Note:</strong> 
                            <div class="alert alert-info">${escapeHtml(permission.leader_note)}</div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="mb-3">
                        <label for="leaderNote" class="form-label">Add Note (Optional)</label>
                        <textarea class="form-control" id="leaderNote" rows="3" placeholder="Add any notes about this decision..."></textarea>
                    </div>
                `;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('reviewPermissionModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading permission details:', error);
                alert('Failed to load permission details. Please try again.');
            }
        }

        async function makeDecision(decision) {
            if (!currentPermissionId) {
                alert('No permission selected');
                return;
            }

            // Disable buttons during submission
            const approveBtn = document.getElementById('approveBtn');
            const appointmentBtn = document.getElementById('appointmentBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            
            [approveBtn, appointmentBtn, rejectBtn].forEach(btn => {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            });

            try {
                const token = localStorage.getItem('token');
                const csrftoken = getCookie('csrftoken');
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (csrftoken) {
                    headers['X-CSRFToken'] = csrftoken;
                }
                if (token) {
                    headers['Authorization'] = `Token ${token}`;
                }

                const leaderNote = document.getElementById('leaderNote')?.value.trim() || '';
                
                const response = await fetch(`/api/leader/permissions/${currentPermissionId}/decision/`, {
                    method: 'PATCH',
                    headers: headers,
                    body: JSON.stringify({
                        decision: decision,
                        leader_note: leaderNote
                    }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.detail || 'Failed to save decision');
                }

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('reviewPermissionModal'));
                modal.hide();

                // Show success message
                const decisionText = decision === 'approved' ? 'Approved' : decision === 'rejected' ? 'Rejected' : 'Appointment Required';
                alert(`Permission request ${decisionText.toLowerCase()} successfully!`);

                // Reload permissions list
                loadPermissions();
                
                // Refresh dashboard if on dashboard page (will be handled by auto-refresh)
                
            } catch (error) {
                console.error('Error making decision:', error);
                alert('Failed to save decision: ' + error.message);
                
                // Re-enable buttons
                [approveBtn, appointmentBtn, rejectBtn].forEach(btn => {
                    btn.disabled = false;
                });
                approveBtn.innerHTML = '<i class="fas fa-check me-2"></i>Approve';
                appointmentBtn.innerHTML = '<i class="fas fa-calendar me-2"></i>Request Appointment';
                rejectBtn.innerHTML = '<i class="fas fa-times me-2"></i>Reject';
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPermissions();
            // Refresh every 30 seconds
            setInterval(loadPermissions, 30000);
        });
    </script>
</body>
</html>